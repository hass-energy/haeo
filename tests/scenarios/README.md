# HAEO Scenario Tests

Quick start guide for testing HAEO with real Home Assistant data.

## Quick Start

### From Diagnostics (Recommended)

Download diagnostics from Home Assistant UI and save directly as a scenario:

1. In Home Assistant: Settings → Devices & Services → HAEO → Download Diagnostics
2. Create a new scenario folder: `mkdir tests/scenarios/my_scenario`
3. Save the downloaded file as `tests/scenarios/my_scenario/scenario.json`
4. Run any test once: `uv run pytest tests/scenarios/test_scenarios.py::test_scenarios[my_scenario] -m scenario`

The test framework will automatically split `scenario.json` into four separate files and delete the original.

## Test Structure

Each scenario uses four separate JSON files:

```
scenario_name/
├── config.json       # HAEO configuration (participants, horizon_hours, period_minutes)
├── environment.json  # HA version, HAEO version, timestamp, timezone
├── inputs.json       # Input sensor states with attributes and forecasts
└── outputs.json      # Expected output sensor states (auto-generated by tests)
```

All scenarios are automatically discovered and tested by `tests/scenarios/test_scenarios.py`.

### Auto-Migration

When you place a unified `scenario.json` file in a scenario folder, the test framework automatically:

1. Detects the unified file at session start
2. Splits it into the four separate JSON files
3. Deletes the original `scenario.json`

This enables the paste-from-diagnostics workflow while keeping diffs clean with separate files.

## What's in Each File

The diagnostics output (and scenario files) contain four sections:

- **config.json**: HAEO configuration (participants, horizon_hours, period_minutes) - user editable
- **environment.json**: HA version, HAEO version, timestamp, timezone - user editable for testing
- **inputs.json**: All input sensor states with attributes and forecasts (list of state dicts)
- **outputs.json**: Output sensor states from optimization (dict mapping entity_id to state dict)

The `environment.json` timestamp is used as the freeze time for the test, and `outputs.json` is compared with actual optimization results.

## Usage Examples

```bash
# From Home Assistant URL (interactive token prompt)
./tests/scenarios/filter_states.py http://ha.local:8123 -o scenario/states.json sensor.battery sensor.solar

# From file with patterns file
./tests/scenarios/filter_states.py states.json -o scenario/states.json --patterns-from-file sensors.txt

# Multiple patterns from file
./tests/scenarios/filter_states.py http://ha.local:8123 \
    -o scenario/states.json sensor.battery_soc sensor.import_price sensor.house_load
```

## Basic Configuration

```json
{
  "integration_type": "hub",
  "name": "Test Network",
  "participants": {
    "battery": {
      "element_type": "battery",
      "capacity": 10000,
      "initial_charge_percentage": "sensor.battery_soc",
      "max_power": 5000
    },
    "solar": {
      "element_type": "photovoltaics",
      "max_power": "sensor.solar_power"
    },
    "grid": {
      "element_type": "grid",
      "import_price": "sensor.electricity_price",
      "export_price": "sensor.feed_in_tariff"
    },
    "load": {
      "element_type": "constant_load",
      "power": "sensor.house_power"
    }
  },
  "connections": [
    [
      "solar",
      "battery"
    ],
    [
      "solar",
      "grid"
    ],
    [
      "battery",
      "grid"
    ],
    [
      "grid",
      "load"
    ],
    [
      "battery",
      "load"
    ]
  ]
}
```

## Running Tests

```bash
# Run all scenarios (use -m scenario to enable scenario tests)
uv run pytest tests/scenarios/test_scenarios.py -m scenario

# Run specific scenario by test ID
uv run pytest tests/scenarios/test_scenarios.py::test_scenarios[scenario1] -m scenario -v

# Update snapshots after changes
uv run pytest tests/scenarios/test_scenarios.py -m scenario --snapshot-update
```

## Visualizations

Each scenario test automatically generates three types of visualizations in the `visualizations/` subdirectory:

### Network Topology Graph

**File**: `{scenario_name}_graph.svg` (and `.png`)

Shows the network structure with:

- **Nodes**: Elements (battery, photovoltaics, grid, load, node) with type-specific colors
- **Edges**: Connections showing power flow with labels showing current power and min/max bounds
- **Layout**: Deterministic spectral layout using NetworkX (arrangement based on graph structure)

Example power labels:

- `19.2kW` - Current power of 19.2kW, no limits configured
- `-5.0 < 5.0kW < 10.0` - Current power of 5.0kW with min/max bounds

All SVG files are deterministic and can be committed to version control.
PNG files are auto-generated but ignored by git (see `.gitignore`).

### Optimization Results

**File**: `{scenario_name}_optimization.svg` (and `.png`)

Stacked area chart showing:

- Production, consumption, and available power over time
- State of charge (SOC) for batteries
- Price forecasts for grid import/export

### Shadow Prices

**File**: `{scenario_name}_shadow_prices.svg` (and `.png`)

Line chart showing optimization shadow prices:

- Constraint shadow prices indicate where the optimization is constrained
- Helps identify bottlenecks in the energy network

## Common Issues

- **Token expired**: Generate new token in Home Assistant UI
- **Connection fails**: Check HA is running and URL is correct
- **States file too large**: Filter to only relevant sensors
- **Integration fails**: Verify all sensor names exist in states.json

## Key Sensor Patterns

- `sensor.battery_*` - Battery sensors
- `sensor.solar_*` - Solar generation
- `sensor.grid_*` - Grid power/pricing
- `sensor.price_*` - Energy pricing
- `input_number.*` - Configuration entities
