"""Test data for battery element configuration."""

from collections.abc import Sequence
from typing import cast

from custom_components.haeo.elements import battery as battery_element
from custom_components.haeo.elements.battery import BatteryConfigData
from custom_components.haeo.model import battery as battery_model
from custom_components.haeo.model.const import (
    OUTPUT_TYPE_ENERGY,
    OUTPUT_TYPE_POWER,
    OUTPUT_TYPE_PRICE,
    OUTPUT_TYPE_SHADOW_PRICE,
    OUTPUT_TYPE_SOC,
)
from custom_components.haeo.model.output_data import OutputData

from .types import ElementConfigData, ElementConfigSchema, ElementValidCase, InvalidModelCase, InvalidSchemaCase

# Single fully-typed pipeline case
VALID: Sequence[ElementValidCase[ElementConfigSchema, ElementConfigData]] = [
    {
        "description": "Adapter mapping battery case",
        "element_type": "battery",
        "schema": battery_element.BatteryConfigSchema(
            element_type="battery",
            name="battery_main",
            connection="network",
            capacity="sensor.battery_capacity",
            initial_charge_percentage="sensor.battery_initial_soc",
            min_charge_percentage=10.0,
            max_charge_percentage=90.0,
            efficiency=95.0,
            max_charge_power=["sensor.battery_max_charge_power"],
            max_discharge_power=["sensor.battery_max_discharge_power"],
            early_charge_incentive=0.01,
            discharge_cost=["sensor.battery_discharge_cost"],
            undercharge_percentage=5.0,
            overcharge_percentage=95.0,
            undercharge_cost=["sensor.battery_undercharge_cost"],
            overcharge_cost=["sensor.battery_overcharge_cost"],
        ),
        "data": BatteryConfigData(
            element_type="battery",
            name="battery_main",
            connection="network",
            capacity=[10.0],
            initial_charge_percentage=[50.0],
            min_charge_percentage=10.0,
            max_charge_percentage=90.0,
            efficiency=95.0,
            max_charge_power=[5.0],
            max_discharge_power=[5.0],
            early_charge_incentive=0.01,
            discharge_cost=[0.02],
            undercharge_percentage=5.0,
            overcharge_percentage=95.0,
            undercharge_cost=[0.03],
            overcharge_cost=[0.04],
        ),
        "model": [
            {
                "element_type": "battery",
                "name": "battery_main",
                "capacity": [10.0],
                "initial_charge_percentage": [50.0],
                "min_charge_percentage": 10.0,
                "max_charge_percentage": 90.0,
                "early_charge_incentive": 0.01,
                "undercharge_percentage": 5.0,
                "overcharge_percentage": 95.0,
                "undercharge_cost": [0.03],
                "overcharge_cost": [0.04],
            },
            {
                "element_type": "connection",
                "name": "battery_main:connection",
                "source": "battery_main",
                "target": "network",
                "efficiency_source_target": 95.0,
                "efficiency_target_source": 95.0,
                "max_power_source_target": [5.0],
                "max_power_target_source": [5.0],
                "price_source_target": [0.02],
            },
        ],
        "model_outputs": {
            "battery_main": {
                battery_model.BATTERY_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(7.0,)),
                battery_model.BATTERY_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(5.0,)),
                battery_model.BATTERY_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(2.0,)),
                battery_model.BATTERY_STATE_OF_CHARGE: OutputData(type=OUTPUT_TYPE_SOC, unit="%", values=(50.0,)),
                battery_model.BATTERY_POWER_BALANCE: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kW", values=(0.01,)),
                battery_model.BATTERY_UNDERCHARGE_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(0.2,)),
                battery_model.BATTERY_UNDERCHARGE_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.0,)),
                battery_model.BATTERY_UNDERCHARGE_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.0,)),
                battery_model.BATTERY_UNDERCHARGE_CHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.001,)),
                battery_model.BATTERY_UNDERCHARGE_DISCHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.002,)),
                battery_model.BATTERY_UNDERCHARGE_ENERGY_IN_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.003,)),
                battery_model.BATTERY_UNDERCHARGE_ENERGY_OUT_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.004,)),
                battery_model.BATTERY_UNDERCHARGE_SOC_MAX: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.005,)),
                battery_model.BATTERY_UNDERCHARGE_SOC_MIN: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.006,)),
            }
        },
        "outputs": {
            battery_element.BATTERY_DEVICE_BATTERY: {
                battery_element.BATTERY_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(7.0,)),
                battery_element.BATTERY_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(5.0,)),
                battery_element.BATTERY_POWER_ACTIVE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(-2.0,), direction=None),
                battery_element.BATTERY_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(2.0,)),
                battery_element.BATTERY_STATE_OF_CHARGE: OutputData(type=OUTPUT_TYPE_SOC, unit="%", values=(50.0,)),
                battery_element.BATTERY_POWER_BALANCE: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kW", values=(0.01,)),
            },
            battery_element.BATTERY_DEVICE_UNDERCHARGE: {
                battery_element.BATTERY_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(0.2,)),
                battery_element.BATTERY_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.0,)),
                battery_element.BATTERY_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.0,)),
                battery_element.BATTERY_CHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.001,)),
                battery_element.BATTERY_DISCHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.002,)),
                battery_element.BATTERY_ENERGY_IN_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.003,)),
                battery_element.BATTERY_ENERGY_OUT_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.004,)),
                battery_element.BATTERY_SOC_MAX: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.005,)),
                battery_element.BATTERY_SOC_MIN: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.006,)),
            },
        },
    },
    {
        "description": "Adapter mapping battery with normal and overcharge outputs",
        "element_type": "battery",
        "schema": battery_element.BatteryConfigSchema(
            element_type="battery",
            name="battery_main",
            connection="network",
            capacity="sensor.battery_capacity",
            initial_charge_percentage="sensor.battery_initial_soc",
            min_charge_percentage=10.0,
            max_charge_percentage=90.0,
            efficiency=95.0,
            max_charge_power=["sensor.battery_max_charge_power"],
            max_discharge_power=["sensor.battery_max_discharge_power"],
            overcharge_percentage=95.0,
            overcharge_cost=["sensor.battery_overcharge_cost"],
        ),
        "data": BatteryConfigData(
            element_type="battery",
            name="battery_main",
            connection="network",
            capacity=[10.0],
            initial_charge_percentage=[50.0],
            min_charge_percentage=10.0,
            max_charge_percentage=90.0,
            efficiency=95.0,
            max_charge_power=[5.0],
            max_discharge_power=[5.0],
            overcharge_percentage=95.0,
            overcharge_cost=[0.04],
        ),
        "model": [
            {
                "element_type": "battery",
                "name": "battery_main",
                "capacity": [10.0],
                "initial_charge_percentage": [50.0],
                "min_charge_percentage": 10.0,
                "max_charge_percentage": 90.0,
                "early_charge_incentive": None,
                "undercharge_percentage": None,
                "undercharge_cost": None,
                "overcharge_percentage": 95.0,
                "overcharge_cost": [0.04],
            },
            {
                "element_type": "connection",
                "name": "battery_main:connection",
                "source": "battery_main",
                "target": "network",
                "efficiency_source_target": 95.0,
                "efficiency_target_source": 95.0,
                "max_power_source_target": [5.0],
                "max_power_target_source": [5.0],
                "price_source_target": None,
            },
        ],
        "model_outputs": {
            "battery_main": {
                battery_model.BATTERY_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(1.0,)),
                battery_model.BATTERY_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.5,)),
                battery_model.BATTERY_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(2.0,)),
                battery_model.BATTERY_STATE_OF_CHARGE: OutputData(type=OUTPUT_TYPE_SOC, unit="%", values=(50.0,)),
                battery_model.BATTERY_POWER_BALANCE: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kW", values=(0.01,)),
                battery_model.BATTERY_NORMAL_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(1.5,)),
                battery_model.BATTERY_NORMAL_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.25,)),
                battery_model.BATTERY_NORMAL_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.1,)),
                battery_model.BATTERY_NORMAL_CHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.001,)),
                battery_model.BATTERY_NORMAL_DISCHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.002,)),
                battery_model.BATTERY_NORMAL_ENERGY_IN_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.003,)),
                battery_model.BATTERY_NORMAL_ENERGY_OUT_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.004,)),
                battery_model.BATTERY_NORMAL_SOC_MAX: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.005,)),
                battery_model.BATTERY_NORMAL_SOC_MIN: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.006,)),
                battery_model.BATTERY_OVERCHARGE_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(0.3,)),
                battery_model.BATTERY_OVERCHARGE_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.2,)),
                battery_model.BATTERY_OVERCHARGE_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.0,)),
                battery_model.BATTERY_OVERCHARGE_CHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.01,)),
                battery_model.BATTERY_OVERCHARGE_DISCHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.02,)),
                battery_model.BATTERY_OVERCHARGE_ENERGY_IN_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.007,)),
                battery_model.BATTERY_OVERCHARGE_ENERGY_OUT_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.008,)),
                battery_model.BATTERY_OVERCHARGE_SOC_MAX: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.009,)),
                battery_model.BATTERY_OVERCHARGE_SOC_MIN: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.001,)),
            }
        },
        "outputs": {
            battery_element.BATTERY_DEVICE_BATTERY: {
                battery_element.BATTERY_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(1.0,)),
                battery_element.BATTERY_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.5,)),
                battery_element.BATTERY_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(2.0,)),
                battery_element.BATTERY_STATE_OF_CHARGE: OutputData(type=OUTPUT_TYPE_SOC, unit="%", values=(50.0,)),
                battery_element.BATTERY_POWER_BALANCE: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kW", values=(0.01,)),
            },
            battery_element.BATTERY_DEVICE_NORMAL: {
                battery_element.BATTERY_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(1.5,)),
                battery_element.BATTERY_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.25,)),
                battery_element.BATTERY_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.1,)),
                battery_element.BATTERY_CHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.001,)),
                battery_element.BATTERY_DISCHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.002,)),
                battery_element.BATTERY_ENERGY_IN_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.003,)),
                battery_element.BATTERY_ENERGY_OUT_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.004,)),
                battery_element.BATTERY_SOC_MAX: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.005,)),
                battery_element.BATTERY_SOC_MIN: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.006,)),
            },
            battery_element.BATTERY_DEVICE_OVERCHARGE: {
                battery_element.BATTERY_ENERGY_STORED: OutputData(type=OUTPUT_TYPE_ENERGY, unit="kWh", values=(0.3,)),
                battery_element.BATTERY_POWER_CHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.2,)),
                battery_element.BATTERY_POWER_DISCHARGE: OutputData(type=OUTPUT_TYPE_POWER, unit="kW", values=(0.0,)),
                battery_element.BATTERY_CHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.01,)),
                battery_element.BATTERY_DISCHARGE_PRICE: OutputData(type=OUTPUT_TYPE_PRICE, unit="$/kWh", values=(0.02,)),
                battery_element.BATTERY_ENERGY_IN_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.007,)),
                battery_element.BATTERY_ENERGY_OUT_FLOW: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.008,)),
                battery_element.BATTERY_SOC_MAX: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.009,)),
                battery_element.BATTERY_SOC_MIN: OutputData(type=OUTPUT_TYPE_SHADOW_PRICE, unit="$/kWh", values=(0.001,)),
            },
        },
    },
]

# Invalid schema-only cases
INVALID_SCHEMA: Sequence[InvalidSchemaCase[ElementConfigSchema]] = [
    {
        "description": "Battery min_charge_percentage greater than max_charge_percentage",
        "schema": {
            "element_type": "battery",
            "name": "test_battery",
            "connection": "network",
            "capacity": "sensor.capacity",
            "initial_charge_percentage": "sensor.initial_soc",
            "min_charge_percentage": 80.0,
            "max_charge_percentage": 20.0,
            "efficiency": 95.0,
        },
    },
]

# Invalid model parameter combinations to exercise runtime validation
INVALID_MODEL_PARAMS: Sequence[InvalidModelCase[ElementConfigData]] = [
    {
        "description": "undercharge percentage set without undercharge cost",
        "element_type": "battery",
        "params": cast(
            battery_element.BatteryConfigData,
            {
                "element_type": "battery",
                "name": "battery_invalid",
                "connection": "network",
                "capacity": [10.0],
                "initial_charge_percentage": [50.0],
                "min_charge_percentage": 10.0,
                "max_charge_percentage": 90.0,
                "efficiency": 95.0,
                "undercharge_percentage": 5.0,
            },
        ),
    },
    {
        "description": "overcharge percentage set without overcharge cost",
        "element_type": "battery",
        "params": cast(
            battery_element.BatteryConfigData,
            {
                "element_type": "battery",
                "name": "battery_invalid",
                "connection": "network",
                "capacity": [10.0],
                "initial_charge_percentage": [50.0],
                "min_charge_percentage": 10.0,
                "max_charge_percentage": 90.0,
                "efficiency": 95.0,
                "overcharge_percentage": 95.0,
            },
        ),
    },
    {
        "description": "min charge not less than max charge",
        "element_type": "battery",
        "params": cast(
            battery_element.BatteryConfigData,
            {
                "element_type": "battery",
                "name": "battery_invalid",
                "connection": "network",
                "capacity": [10.0],
                "initial_charge_percentage": [50.0],
                "min_charge_percentage": 90.0,
                "max_charge_percentage": 90.0,
                "efficiency": 95.0,
            },
        ),
    },
    {
        "description": "undercharge not below min",
        "element_type": "battery",
        "params": cast(
            battery_element.BatteryConfigData,
            {
                "element_type": "battery",
                "name": "battery_invalid",
                "connection": "network",
                "capacity": [10.0],
                "initial_charge_percentage": [50.0],
                "min_charge_percentage": 20.0,
                "max_charge_percentage": 90.0,
                "efficiency": 95.0,
                "undercharge_percentage": 20.0,
                "undercharge_cost": [1.0],
            },
        ),
    },
    {
        "description": "overcharge not above max",
        "element_type": "battery",
        "params": cast(
            battery_element.BatteryConfigData,
            {
                "element_type": "battery",
                "name": "battery_invalid",
                "connection": "network",
                "capacity": [10.0],
                "initial_charge_percentage": [50.0],
                "min_charge_percentage": 10.0,
                "max_charge_percentage": 90.0,
                "efficiency": 95.0,
                "overcharge_percentage": 90.0,
                "overcharge_cost": [1.0],
            },
        ),
    },
]
